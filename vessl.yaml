name: eigenscore-llama7b-4gpu

resources:
  cluster: snu-eng-dgx
  preset: a100-4

image: quay.io/vessl-ai/torch:2.3.1-cuda12.1

env:
  HF_HUB_CACHE: /root/.cache/huggingface
  PYTORCH_ALLOC_CONF: expandable_segments:True

run:
  - command: |
      mkdir -p $HF_HUB_CACHE

      echo "Cloning repository..."
      git clone https://github.com/Seongryun951/Gradproj.git /root/code
      cd /root/code

      echo "Installing requirements..."
      pip install --upgrade pip
      pip install -r requirements.txt

      # Hugging Face 인증 (LLaMA는 gated model, pip install 후에 실행)
      huggingface-cli login --token $HF_TOKEN

      echo "Checking GPUs..."
      nvidia-smi
      python -c "import torch; print(f'GPU count: {torch.cuda.device_count()}')"

      mkdir -p /root/code/eigenscore/data/output
      mkdir -p /root/code/eigenscore/output

      echo "Starting EigenScore pipeline (LLaMA-2-7B) on 4 GPUs..."
      cd /root/code/eigenscore

      python -m pipeline.generate \
        --model llama-7b-hf --dataset coqa \
        --fraction_of_data_to_use 1.0 --project_ind 0 \
        --device cuda:0 --num_generations_per_prompt 10 \
        --temperature 0.5 --top_p 0.99 --top_k 10 \
        --seed 2023 --shard_id 0 --num_shards 4 &

      python -m pipeline.generate \
        --model llama-7b-hf --dataset coqa \
        --fraction_of_data_to_use 1.0 --project_ind 1 \
        --device cuda:1 --num_generations_per_prompt 10 \
        --temperature 0.5 --top_p 0.99 --top_k 10 \
        --seed 2023 --shard_id 1 --num_shards 4 &

      python -m pipeline.generate \
        --model llama-7b-hf --dataset coqa \
        --fraction_of_data_to_use 1.0 --project_ind 2 \
        --device cuda:2 --num_generations_per_prompt 10 \
        --temperature 0.5 --top_p 0.99 --top_k 10 \
        --seed 2023 --shard_id 2 --num_shards 4 &

      python -m pipeline.generate \
        --model llama-7b-hf --dataset coqa \
        --fraction_of_data_to_use 1.0 --project_ind 3 \
        --device cuda:3 --num_generations_per_prompt 10 \
        --temperature 0.5 --top_p 0.99 --top_k 10 \
        --seed 2023 --shard_id 3 --num_shards 4 &

      wait

      echo "All 4 shards completed!"
      ls -lh /root/code/eigenscore/output/
      ls -lh /root/code/eigenscore/data/output/
